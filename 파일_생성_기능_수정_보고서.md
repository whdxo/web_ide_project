# 파일 생성 및 폴더 생성 기능 수정 보고서

## 작업 일자
2025-12-27

## 수정 개요
Web IDE의 파일 생성, 폴더 생성 기능이 동작하지 않는 문제를 해결하고, 프론트엔드-백엔드 간 타입 불일치 문제를 수정했습니다.

## 해결된 문제들

### 1. CORS 정책 차단
**증상**: 프론트엔드(localhost:5174)에서 백엔드(localhost:8080) API 호출 시 CORS 에러 발생
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**원인**: SecurityConfig에 localhost:5174가 허용된 Origin으로 등록되지 않음

**해결**:
- 파일: `backend/src/main/java/com/editus/backend/global/config/SecurityConfig.java`
- 변경: localhost:5174를 CORS 허용 목록에 추가 (89번째 줄)

### 2. 루트 레벨 파일 생성 불가
**증상**: 폴더 없이 루트에 파일 생성 시 `IllegalArgumentException: The given id must not be null` 에러

**원인**:
- `folderId`가 null일 때도 폴더 검증 로직이 실행됨
- `folderRepository.findById(null)` 호출로 인한 에러

**해결**:
- 파일: `backend/src/main/java/com/editus/backend/domain/file/service/FileTreeService.java`
- 변경: folderId가 null이 아닐 때만 폴더 유효성 검사 수행 (33-42번째 줄)
```java
if (req.getFolderId() != null) {
    Folder folder = folderRepository.findById(req.getFolderId())
            .orElseThrow(() -> new IllegalArgumentException("폴더가 존재하지 않습니다."));
    // 검증 로직...
}
```

### 3. 데이터베이스 스키마 제약조건
**증상**: `Column 'folder_id' cannot be null` SQL 에러 (에러 코드 1048)

**원인**:
- JPA 엔티티는 folderId를 nullable로 허용
- 데이터베이스 테이블은 NOT NULL 제약조건 설정

**해결**:
1. JPA 엔티티 수정
   - 파일: `backend/src/main/java/com/editus/backend/domain/file/entity/IdeFile.java`
   - 변경: `@Column(nullable = false)` 제거 (24번째 줄)

2. 데이터베이스 스키마 수정
   ```sql
   ALTER TABLE ide_file MODIFY COLUMN folder_id BIGINT NULL;
   ```

3. 유효성 검증 제거
   - 파일: `backend/src/main/java/com/editus/backend/domain/file/dto/CreateFileRequest.java`
   - 변경: `@NotNull` 어노테이션 제거

### 4. 프론트엔드 타입 불일치
**증상**:
- "Cannot read properties of undefined (reading 'content')" 에러
- 500 Internal Server Error

**원인**: 백엔드는 camelCase 응답하지만 프론트엔드는 snake_case 타입 정의 사용

**해결**:
- 파일: `frontend/src/shared/features-types/file.types.ts`
- 변경: 모든 인터페이스를 백엔드 DTO와 일치하도록 camelCase로 수정

**변경 전**:
```typescript
export interface FileDetail {
  file_id: number;
  parent_folder_id: number | null;
  // ...
}
```

**변경 후**:
```typescript
export interface FileDetail {
  id: number;
  folderId: number | null;
  name: string;
  language: string;
  content: string;
}
```

### 5. React Query 이중 데이터 접근
**증상**: "Query data cannot be undefined" 에러

**원인**: API 함수가 이미 `response.data`를 반환하는데 훅에서 다시 `.data` 접근

**해결**:
- 파일: `frontend/src/features/fileTree/hooks/useFileTree.ts`
- 변경: `return response.data;` → `return response;` (10번째 줄)

### 6. 폴더 생성 시 updated_at 필드 누락
**증상**: 폴더 생성 시 `Field 'updated_at' doesn't have a default value` 에러

**원인**: 데이터베이스에는 updated_at 컬럼이 있지만 엔티티에 필드 누락

**해결**:
- 파일: `backend/src/main/java/com/editus/backend/domain/file/entity/Folder.java`
- 변경: updatedAt 필드 추가 및 @PrePersist, @PreUpdate 콜백 구현

### 7. 파일 확장자 기반 언어 자동 감지
**개선 사항**: 파일 생성 시 확장자를 분석하여 자동으로 언어 설정

**구현**:
- 파일: `frontend/src/features/fileTree/components/FileTree.tsx`
- 추가: 확장자-언어 매핑 로직 (22-36번째 줄)
```typescript
const ext = tempName.trim().split('.').pop()?.toLowerCase();
const languageMap: { [key: string]: string } = {
  'js': 'javascript',
  'ts': 'typescript',
  'py': 'python',
  'java': 'java',
  // ...
};
```

## 수정된 파일 목록

### 백엔드 (5개 파일)
1. `CreateFileRequest.java` - folderId 유효성 검증 제거
2. `Folder.java` - updatedAt 필드 추가
3. `IdeFile.java` - folderId nullable 허용
4. `FileTreeService.java` - null folderId 처리 로직 추가
5. `SecurityConfig.java` - CORS 설정에 localhost:5174 추가

### 프론트엔드 (3개 파일)
1. `file.types.ts` - 모든 인터페이스를 camelCase로 변경
2. `useFileTree.ts` - 이중 데이터 접근 문제 수정
3. `FileTree.tsx` - 언어 자동 감지 기능 추가, 필드명 수정

## 테스트 결과

### 성공한 기능 ✅
- 파일 생성: test.py 파일 루트 레벨에 생성 성공
- 파일 트리 표시: 생성된 파일이 트리에 정상 표시
- CORS: 프론트엔드-백엔드 통신 정상
- 로그인 및 프로젝트 접속: 정상 동작
- 언어 자동 감지: .py → python 자동 설정

### 알려진 남은 이슈 ❌
- 코드 에디터 로딩: 파일 클릭 시 화면이 검게 변하며 Monaco 에디터가 로드되지 않음
  - 백엔드 로그는 정상 (GET /api/files/1 → 200 OK)
  - 프론트엔드 컴포넌트 렌더링 문제로 추정
  - 향후 별도 수정 필요

## 분석 및 결론

### 코드 수정 적절성 평가
✅ **모든 수정 사항이 적절함**

1. **일관성**: 프론트엔드-백엔드 간 데이터 타입이 일치하도록 수정
2. **비즈니스 로직**: 루트 레벨 파일 생성을 지원하는 것은 IDE의 정상적인 기능
3. **보안**: CORS 설정 추가는 개발 환경에서 필수적
4. **데이터 무결성**: 데이터베이스 스키마와 JPA 엔티티 일치
5. **사용자 경험**: 파일 확장자 기반 언어 자동 감지로 편의성 향상

### 기능 검증
- 파일 생성 기능: **정상 동작 확인**
- 폴더 생성 기능: **코드 수정 완료** (실제 테스트 미실시)
- API 통신: **정상**
- 데이터 흐름: **프론트엔드 ↔ 백엔드 정상**

### 향후 작업
1. 코드 에디터 로딩 문제 해결
2. 폴더 생성 기능 실제 테스트
3. 파일 삭제, 폴더 삭제 기능 테스트
4. 파일 내용 수정 및 저장 기능 테스트
